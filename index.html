<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Surf Spot Weather</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }

    /* Wind arrow marker */
    .wind-marker {
      width: 24px;
      height: 24px;
      transform-origin: center center;
    }

    /* Popup table */
    .wind-table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
    }
    .wind-table th, .wind-table td {
      border: 1px solid #ddd;
      padding: 2px 4px;
      text-align: center;
    }
    .wind-table tr.good {
      background-color: #b2f2bb; /* light green */
    }

    /* Mobile optimization */
    @media (max-width: 600px) {
      .wind-table {
        font-size: 10px;
      }
      .leaflet-popup-content {
        max-width: 250px !important;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([62.939, 23.184], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Create custom SVG arrow marker
    function createWindIcon(direction, speed) {
      let color = "red";
      if (speed >= 5) color = "green";
      else if (speed >= 3) color = "orange";

      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
             viewBox="0 0 24 24" style="transform: rotate(${direction}deg)">
          <polygon points="12,2 22,22 12,17 2,22" fill="${color}" />
        </svg>`;
      return L.divIcon({
        className: 'wind-marker',
        html: svg,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });
    }

    // Fetch forecast from Yr.no
    async function fetchForecast(lat, lon) {
      const res = await fetch(
        `https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${lat}&lon=${lon}`,
        { headers: { "User-Agent": "surf-app/1.0" } }
      );
      return res.json();
    }

    // Build forecast table
    function buildForecastTable(timeseries, bestDirs) {
      const rows = timeseries.slice(0, 12).map(entry => {
        const t = entry.time.substring(11,16);
        const wind = entry.data.instant.details.wind_speed;
        const gust = entry.data.instant.details.wind_speed_of_gust;
        const dir = entry.data.instant.details.wind_from_direction;
        const isGood = wind >= 5 && dir >= bestDirs[0] && dir <= bestDirs[1];
        return `
          <tr class="${isGood ? 'good' : ''}">
            <td>${t}</td>
            <td>${wind.toFixed(1)}</td>
            <td>${Math.round(dir)}°</td>
          </tr>`;
      }).join("");
      return `
        <table class="wind-table">
          <tr><th>Time</th><th>Wind</th><th>Dir</th></tr>
          ${rows}
        </table>`;
    }

    // Load external GeoJSON spots
    fetch("spots.geojson")
      .then(res => res.json())
      .then(spots => {
        L.geoJSON(spots, {
          pointToLayer: function(feature, latlng) {
            const marker = L.marker(latlng);
            // fetch forecast & update icon + popup
            fetchForecast(latlng.lat, latlng.lng).then(data => {
              const timeseries = data.properties.timeseries;
              const current = timeseries[0].data.instant.details;
              const wind = current.wind_speed;
              const dir = current.wind_from_direction;

              // set wind arrow marker
              marker.setIcon(createWindIcon(dir, wind));

              // popup with forecast table
              const table = buildForecastTable(timeseries, feature.properties.best_wind_dir);
              marker.bindPopup(`<b>${feature.properties.name}</b><br>
                                Best wind: ${feature.properties.best_wind_dir[0]}°–${feature.properties.best_wind_dir[1]}°<br>
                                Current: ${wind.toFixed(1)} m/s (${Math.round(dir)}°)<br>
                                Notes: ${feature.properties.notes}<br>
                                ${table}`);
            });
            return marker;
          }
        }).addTo(map);
      });
  </script>
</body>
</html>
